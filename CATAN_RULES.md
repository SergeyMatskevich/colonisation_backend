# Правила игры Catan - Документация реализации

## Обзор

В этом документе описаны правила игры Колонизаторы (Catan), реализованные в данном бекенде. Реализация включает **полные базовые правила** классической версии игры с правильной геометрией игрового поля, начальной фазой, торговлей, развивающими картами, портами и полным функционалом разбойника.

## Основные правила игры

### Цель игры

Игроки соревнуются за первыми набрать **10 очков победы**. Очки начисляются за:
- Поселения: **1 очко**
- Города: **2 очка**
- Самая длинная дорога: **2 очка** (минимум 5 дорог)
- Самая большая армия: **2 очка** (минимум 3 рыцаря)
- Карты очков победы: **1 очко** каждая (развивающие карты)

### Игровое поле

#### Гексы (Hexes)

Игровое поле состоит из **19 гексов**:
- **4 гекса леса** (Wood) - дают ресурс "Лес"
- **3 гекса холмов** (Hills) - дают ресурс "Глина" (Brick)
- **4 гекса пастбищ** (Pasture) - дают ресурс "Овца" (Sheep)
- **4 гекса полей** (Fields) - дают ресурс "Пшеница" (Wheat)
- **3 гекса гор** (Mountains) - дают ресурс "Камень" (Ore)
- **1 гекс пустыни** (Desert) - не дает ресурсов (разбойник начинает здесь)

#### Номера на гексах

На каждом гексе (кроме пустыни) размещен номер от **2 до 12**:
- Номера определяют, когда игроки получают ресурсы
- При броске двух кубиков, если выпадает номер гекса, все игроки с постройками рядом получают ресурсы этого типа
- **7** - особый номер, активирует разбойника (robber)

#### Вершины (Vertices)

- Каждый гекс имеет **6 вершин**
- Игровое поле содержит **114 вершин** (с учетом правильной гексагональной геометрии)
- На вершинах можно строить **поселения** и **города**
- Поселения и города должны находиться минимум в **2 ребрах** друг от друга (точная проверка через геометрию)
- Некоторые вершины могут иметь **порты** для специальной торговли

#### Ребра (Edges)

- Ребра соединяют вершины
- Игровое поле содержит **285 ребер** (правильная гексагональная геометрия)
- На ребрах можно строить **дороги**
- Дороги должны быть связаны с существующими постройками игрока или другими дорогами
- Самая длинная непрерывная дорога вычисляется через граф (поиск в глубину)

### Ресурсы

В игре 5 типов ресурсов:

1. **Лес (Wood)** - зеленый
2. **Глина (Brick)** - красный
3. **Овца (Sheep)** - белый
4. **Пшеница (Wheat)** - желтый
5. **Камень (Ore)** - серый

### Строительство

#### Поселение (Settlement)

**Стоимость:**
- 1 Лес
- 1 Глина
- 1 Овца
- 1 Пшеница

**Очки:** 1 очко победы

**Условия:**
- Должно быть на свободной вершине
- Минимум 2 ребра от любого другого поселения/города
- Должно быть связано с дорогой игрока (кроме начальной фазы)

#### Город (City)

**Стоимость:**
- 3 Камня
- 2 Пшеницы

**Очки:** 2 очка победы

**Условия:**
- Можно строить только на месте существующего поселения игрока
- Улучшает поселение до города

#### Дорога (Road)

**Стоимость:**
- 1 Лес
- 1 Глина

**Очки:** нет (но может дать 2 очка за самую длинную дорогу)

**Условия:**
- Должна быть на свободном ребре
- Должна быть связана с существующим поселением/городом игрока или другой дорогой игрока

### Ход игры

#### Фазы игры

1. **Начальная фаза (Initial Setup)** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - Каждый игрок ставит по 2 поселения и 2 дороги
   - **Первый раунд:** по часовой стрелке (игроки ставят первое поселение и дорогу)
   - **Второй раунд:** против часовой стрелки (игроки ставят второе поселение и дорогу)
   - При размещении **второго поселения** (второй раунд) игрок получает ресурсы от всех гексов вокруг него
   - Проверка расстояния между поселениями работает с правильной геометрией
   - После завершения начальной фазы игра переходит в обычную фазу

2. **Основная фаза (Turn)** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - Каждый ход состоит из следующих этапов:
     a. **Бросок кубиков** - обязательно
     b. **Распределение ресурсов** - автоматически (если не выпало 7, с учетом разбойника)
     c. **Торговля** - опционально (с банком, через порты, между игроками)
     d. **Строительство** - опционально (поселения, города, дороги)
     e. **Использование развивающих карт** - опционально
     f. **Конец хода** - переход к следующему игроку

#### Разбойник (Robber) ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

Когда выпадает **7**:
1. **Сброс ресурсов:** Все игроки с 7+ ресурсов должны сбросить половину (округление вниз)
   - Игроки автоматически сбрасывают случайные ресурсы (в полной версии игроки выбирают)
2. **Перемещение разбойника:** Текущий игрок перемещает разбойника на любой другой гекс
   - Разбойник блокирует сбор ресурсов с гекса, на котором находится
   - Гекс с разбойником не дает ресурсов даже при выпадении его номера
3. **Кража ресурса:** Игрок может взять один случайный ресурс у игрока, имеющего постройку на новом гексе разбойника
   - Если на гексе несколько построек разных игроков, игрок выбирает жертву
   - Если у жертвы нет ресурсов, кража не происходит

### Торговля ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

#### Торговля с банком

- **Стандартный обмен:** 4 ресурса одного типа = 1 ресурс любого типа
- Можно обменивать любые ресурсы
- Нет ограничений на количество обменов за ход

#### Торговля через порты

- **Общий порт (3:1):** 3 любых ресурса = 1 любой ресурс
- **Специальные порты (2:1):** 2 конкретных ресурса = 1 любой ресурс
  - Порт леса (Wood)
  - Порт глины (Brick)
  - Порт овцы (Sheep)
  - Порт пшеницы (Wheat)
  - Порт камня (Ore)
- Порты расположены на краю игрового поля (на специальных вершинах)
- Для торговли через порт нужно построить поселение или город на вершине с портом

#### Торговля между игроками ✅ РЕАЛИЗОВАНО

- Игроки могут предлагать друг другу торговые сделки
- Предложение торговли: игрок указывает, что дает и что хочет получить
- Другие игроки могут принять предложение
- Принятие предложения автоматически обменивает ресурсы между игроками

### Развивающие карты ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

#### Покупка развивающих карт

**Стоимость:**
- 1 Овца (Sheep)
- 1 Пшеница (Wheat)
- 1 Камень (Ore)

Карты берутся из колоды случайным образом (нельзя выбрать конкретную карту).

#### Типы развивающих карт

1. **Рыцарь (Knight)** - 14 карт в колоде
   - Перемещает разбойника
   - Каждый сыгранный рыцарь засчитывается для "Самая большая армия"
   - Можно играть только в свой ход (не сразу после покупки)

2. **Очко победы (Victory Point)** - 5 карт в колоде
   - Дает 1 очко победы сразу при покупке
   - Остается скрытой до конца игры (для сюрприза)

3. **Строительство дорог (Road Building)** - 2 карты в колоде
   - Позволяет построить 2 дороги бесплатно
   - Можно играть сразу после покупки

4. **Год изобилия (Year of Plenty)** - 2 карты в колоде
   - Игрок берет 2 любых ресурса из банка
   - Можно играть сразу после покупки

5. **Монополия (Monopoly)** - 2 карты в колоде
   - Игрок забирает все карты указанного типа у всех игроков
   - Можно играть сразу после покупки

**Важно:** Карты, купленные в текущий ход, нельзя играть в этот же ход (кроме карт, которые можно играть сразу).

### Порты ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

- **9 портов** расположены на краю игрового поля
- **4 общих порта** (3:1) - обмен 3 любых ресурса на 1 любой
- **5 специальных портов** (2:1) - по одному для каждого типа ресурса
- Порты назначаются случайным образом на краевые вершины при генерации доски
- Для использования порта нужно иметь поселение или город на вершине с портом

### Специальные карты

#### Самая длинная дорога (Longest Road) ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

- Присуждается игроку с непрерывной дорогой минимум из **5 участков**
- Дает **2 очка победы**
- Если другой игрок строит более длинную дорогу, карта переходит к нему
- Вычисляется через **поиск в глубину (DFS)** для нахождения самой длинной непрерывной цепи
- При ничьей текущий обладатель сохраняет карточку

#### Самая большая армия (Largest Army) ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

- Присуждается игроку с минимум **3 сыгранными рыцарями** (развивающие карты)
- Дает **2 очка победы**
- Если другой игрок играет больше рыцарей, карта переходит к нему
- Счетчик рыцарей увеличивается каждый раз, когда игрок играет карту Рыцарь

### Конец игры

Игра заканчивается, когда игрок достигает **10 очков победы**:
- Очки считаются в конце хода
- Игрок должен объявить победу при достижении 10 очков

## Реализованные функции

### ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО

1. **Генерация игрового поля с правильной геометрией** ✅
   - Стандартная раскладка из 19 гексов
   - **Правильная гексагональная геометрия** с координатами (q, r)
   - 114 вершин с точными координатами
   - 285 ребер, правильно соединяющих вершины
   - Распределение типов ресурсов (случайное, но стандартное количество)
   - Номера на гексах (2-12, случайная раскладка)
   - Автоматическое назначение портов на краевые вершины

2. **Полная игровая логика** ✅
   - Бросок кубиков (2 кубика, сумма 2-12)
   - **Точное распределение ресурсов** с учетом правильной геометрии
   - Постройки получают ресурсы от всех прилегающих гексов
   - Города дают 2 ресурса, поселения - 1 ресурс
   - Строительство поселений с проверкой расстояния через геометрию
   - Строительство городов (улучшение поселений)
   - Строительство дорог с проверкой связи через граф

3. **Проверки правил с правильной геометрией** ✅
   - Проверка стоимости постройки
   - **Точная проверка расстояния между поселениями** (минимум 2 ребра)
   - **Правильная проверка связи дорог** через граф (поиск в ширину)
   - Подсчет очков победы (включая карты очков)
   - Проверка принадлежности вершин к гексам

4. **Начальная фаза** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - Полная реализация двух раундов расстановки
   - Первый раунд: по часовой стрелке
   - Второй раунд: против часовой стрелки
   - Выдача ресурсов при размещении второго поселения
   - Правильная проверка расстояния в начальной фазе
   - Автоматический переход к обычной фазе после завершения

5. **Полный функционал разбойника** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - Автоматический сброс ресурсов при выпадении 7
   - Перемещение разбойника на любой гекс
   - Блокировка ресурсов с гекса, где находится разбойник
   - Кража случайного ресурса у игрока с постройкой на гексе
   - Правильное определение построек на гексе через геометрию

6. **Торговля** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - Торговля с банком (4:1) - стандартный обмен
   - Торговля через порты:
     - Общие порты (3:1)
     - Специальные порты (2:1) для каждого типа ресурса
   - Торговля между игроками:
     - Создание предложений торговли
     - Принятие предложений другими игроками
     - Автоматический обмен ресурсов при принятии

7. **Развивающие карты** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - Покупка развивающих карт (1 овца, 1 пшеница, 1 камень)
   - Колода из 25 карт (14 рыцарей, 5 очков победы, 2 строительства дорог, 2 года изобилия, 2 монополии)
   - Все типы карт реализованы:
     - Рыцарь (Knight) - перемещает разбойника, учитывается для армии
     - Очко победы (Victory Point) - дается сразу при покупке
     - Строительство дорог (Road Building) - 2 бесплатные дороги
     - Год изобилия (Year of Plenty) - берет 2 любых ресурса
     - Монополия (Monopoly) - забирает все ресурсы указанного типа
   - Подсчет самой большой армии (минимум 3 рыцаря)

8. **Порты** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - 9 портов на игровом поле
   - 4 общих порта (3:1)
   - 5 специальных портов (2:1) - по одному на каждый ресурс
   - Порты назначаются на краевые вершины при генерации
   - Торговля через порты требует постройки на вершине с портом

9. **Самая длинная дорога** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
   - Вычисление через граф дорог игрока
   - Поиск в глубину (DFS) для нахождения самой длинной непрерывной цепи
   - Минимум 5 дорог для получения карточки
   - Автоматическое переключение при постройке более длинной дороги

10. **Самая большая армия** ✅ ПОЛНОСТЬЮ РЕАЛИЗОВАНО
    - Подсчет сыгранных рыцарей для каждого игрока
    - Минимум 3 рыцаря для получения карточки
    - Автоматическое переключение при игре большего количества рыцарей

11. **AI игроки** ✅
    - Простая логика принятия решений
    - Автоматическое строительство
    - Базовая торговля с банком (4:1)
    - Автоматический ход при передаче хода

12. **API endpoints** ✅ РАСШИРЕНО
    - Запуск игры с правильной геометрией
    - Получение состояния игры
    - Бросок кубиков с обработкой разбойника
    - Строительство построек (с правильной геометрией)
    - **Новые endpoints:**
      - Перемещение разбойника
      - Торговля с банком
      - Торговля через порты
      - Покупка развивающих карт
      - Использование развивающих карт
      - Действия в начальной фазе
      - Создание предложений торговли
      - Принятие предложений торговли
    - Завершение хода (с поддержкой начальной фазы)

## Структура данных игры

### Game State (JSON)

```json
{
  "players": [
    {
      "player_id": 1,
      "position": 1,
      "is_ai": false,
      "victory_points": 2
    }
  ],
  "hexes": [
    {
      "hex_index": 0,
      "hex_type": "forest",
      "number": 5,
      "has_robber": false
    }
  ],
  "vertices": [
    {
      "vertex_id": 0,
      "x": 0,
      "y": 0,
      "owner_id": 1,
      "building_type": "settlement"
    }
  ],
  "edges": [
    {
      "edge_id": 0,
      "vertex1_id": 0,
      "vertex2_id": 1,
      "owner_id": 1
    }
  ],
  "player_resources": {
    "1": {
      "wood": 2,
      "brick": 1,
      "sheep": 0,
      "wheat": 1,
      "ore": 0
    }
  },
  "current_player_index": 0,
  "phase": "turn",
  "last_dice_roll": 6,
  "longest_road_player": 1,
  "largest_army_player": null
}
```


## Обновленная структура данных игры

### Game State (JSON) - Полная версия

```json
{
  "players": [
    {
      "player_id": 1,
      "position": 1,
      "is_ai": false,
      "victory_points": 5
    }
  ],
  "hexes": [
    {
      "hex_index": 0,
      "hex_coord": [0, -2],
      "hex_type": "forest",
      "number": 5,
      "has_robber": false
    }
  ],
  "hex_layout": [[0, -2], [1, -2], ...],
  "vertices": [
    {
      "vertex_id": 0,
      "x": 50.0,
      "y": -100.0,
      "owner_id": 1,
      "building_type": "settlement",
      "has_port": false
    }
  ],
  "vertices_dict": {
    "0": { "vertex_id": 0, "x": 50.0, ... }
  },
  "edges": [
    {
      "edge_id": 0,
      "vertex1_id": 0,
      "vertex2_id": 1,
      "owner_id": 1
    }
  ],
  "player_resources": {
    "1": {
      "wood": 2,
      "brick": 1,
      "sheep": 0,
      "wheat": 1,
      "ore": 0
    }
  },
  "player_dev_cards": {
    "1": ["knight", "victory_point"]
  },
  "player_played_knights": {
    1: 2
  },
  "current_player_index": 0,
  "phase": "turn",
  "setup_phase": {
    "round": 1,
    "player_index": 0,
    "actions": []
  },
  "last_dice_roll": 6,
  "longest_road_player": 1,
  "longest_road_length": 5,
  "largest_army_player": null,
  "robber_location": 9,
  "ports": {
    "5": {
      "port_type": "wood",
      "trade_ratio": "2:1"
    }
  },
  "dev_cards_deck": ["knight", "knight", ...],
  "pending_trades": []
}
```

## API Endpoints - Полный список

### Базовые endpoints

#### Запуск игры
```
POST /api/v1/catan/start
Body: { "game_id": 1 }
```

#### Получение состояния игры
```
GET /api/v1/catan/{game_id}/state
```

#### Бросок кубиков
```
POST /api/v1/catan/{game_id}/roll-dice
```
Примечание: Если выпадает 7, автоматически обрабатывается разбойник.

#### Завершение хода
```
POST /api/v1/catan/{game_id}/end-turn
```

### Строительство

#### Строительство поселения
```
POST /api/v1/catan/{game_id}/build-settlement
Body: { "vertex_id": 5 }
```

#### Строительство города
```
POST /api/v1/catan/{game_id}/build-city
Body: { "vertex_id": 5 }
```

#### Строительство дороги
```
POST /api/v1/catan/{game_id}/build-road
Body: { "vertex1_id": 5, "vertex2_id": 6 }
```

### Разбойник

#### Перемещение разбойника
```
POST /api/v1/catan/{game_id}/move-robber
Body: {
  "hex_index": 10,
  "steal_from_player_id": 2  // опционально
}
```

### Торговля

#### Торговля с банком (4:1)
```
POST /api/v1/catan/{game_id}/trade-bank
Body: {
  "give_resource": "wood",
  "give_amount": 4,
  "take_resource": "brick",
  "take_amount": 1
}
```

#### Торговля через порт
```
POST /api/v1/catan/{game_id}/trade-port
Body: {
  "vertex_id": 15,  // вершина с портом
  "give_resource": "wood",
  "give_amount": 2,  // для специального порта
  "take_resource": "brick",
  "take_amount": 1
}
```

#### Создание предложения торговли
```
POST /api/v1/catan/{game_id}/create-trade-offer
Body: {
  "give_resources": {"wood": 2, "brick": 1},
  "want_resources": {"sheep": 1, "wheat": 1}
}
```

#### Принятие предложения торговли
```
POST /api/v1/catan/{game_id}/accept-trade-offer
Body: {
  "trade_offer_id": 0
}
```

### Развивающие карты

#### Покупка развивающей карты
```
POST /api/v1/catan/{game_id}/buy-dev-card
```

#### Использование развивающей карты
```
POST /api/v1/catan/{game_id}/play-dev-card
Body: {
  "card_type": "knight",  // или "road_building", "year_of_plenty", "monopoly"
  "card_data": {  // только для year_of_plenty и monopoly
    "resource1": "wood",
    "resource2": "brick",
    // или для monopoly:
    "resource_type": "wood"
  }
}
```

### Начальная фаза

#### Действие в начальной фазе
```
POST /api/v1/catan/{game_id}/initial-setup
Body: {
  "action": "place_settlement",  // или "place_road"
  "vertex_id": 5,  // для поселения
  // или для дороги:
  "vertex1_id": 5,
  "vertex2_id": 6
}
```

## Ограничения и упрощения

1. **Выбор ресурсов при сбросе (7)**: При выпадении 7 игроки автоматически сбрасывают случайные ресурсы. В полной версии игроки должны выбирать ресурсы сами.

2. **Выбор ресурсов для кражи**: При краже разбойником берется случайный ресурс. В полной версии игрок должен видеть ресурсы жертвы и выбирать.

3. **AI**: Реализована простая логика AI. Более продвинутый AI требует разработки эвристик и стратегий:
   - Оценка позиций для построек
   - Приоритизация ресурсов
   - Стратегическое планирование
   - Анализ вероятностей выпадения номеров

4. **Валидация выбора**: Некоторые действия, где игрок должен выбрать (например, какие ресурсы сбросить), упрощены.

5. **Торговля между игроками**: Предложения торговли создаются, но нет механизма уведомлений других игроков в реальном времени (требуется polling).

## Планы на будущее

- [x] ✅ Полная реализация начальной фазы
- [x] ✅ Точная геометрия игрового поля
- [x] ✅ Торговля между игроками
- [x] ✅ Развивающие карты
- [x] ✅ Порты и специальная торговля
- [x] ✅ Разбойник с полным функционалом
- [ ] Улучшенный AI с эвристиками и стратегиями
- [ ] Многопользовательская игра в реальном времени (WebSocket)
- [ ] Сохранение и загрузка игр
- [ ] Система рейтингов и статистики
- [ ] Реплеи игр
- [ ] Турнирный режим
- [ ] Расширения (Cities & Knights, Seafarers и т.д.)

## Ссылки на правила

Официальные правила игры Catan можно найти на сайте издателя или в официальном руководстве игры.

---

## Резюме реализации

Все базовые правила игры Catan успешно реализованы:

✅ **Геометрия:** Правильная гексагональная геометрия с 19 гексами, 114 вершинами и 285 ребрами  
✅ **Начальная фаза:** Полная реализация двух раундов расстановки с выдачей ресурсов  
✅ **Распределение ресурсов:** Точное распределение ресурсов с учетом геометрии  
✅ **Строительство:** Поселения, города и дороги с правильной проверкой расстояния и связи  
✅ **Разбойник:** Полный функционал перемещения, блокировки ресурсов и кражи  
✅ **Торговля:** С банком (4:1), через порты (3:1, 2:1), между игроками  
✅ **Развивающие карты:** Все 5 типов карт (Рыцарь, Очко победы, Строительство дорог, Год изобилия, Монополия)  
✅ **Порты:** 9 портов с правильным размещением и функционалом торговли  
✅ **Специальные карточки:** Самая длинная дорога и самая большая армия  
✅ **Победа:** Проверка достижения 10 очков победы  
✅ **AI:** Базовая логика для компьютерных игроков  

Все функции доступны через REST API endpoints.

---

*Документация обновлена: 2026-01-10*

